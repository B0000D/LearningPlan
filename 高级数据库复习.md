# 高级数据库复习

## 重点

第1章:看看就行

第2章:2.5 习题2.5.1

2.7 习题2.7.2

第3章 3.1 习题3.3.3 3.3.5

3.2 图3-2,1 3-2,3 3-2,4

3.3

第4章

4.1 

4.2 伪代码 步骤

4.4 **4.4.2** **4.4.3** 4.4.5步骤

习题4.4.1步骤 4.4.4 I/O 复杂度

第5章

5.1 sql语句-> 语法树 图5-3,5-4,5-5,习题5.1.3

5.4 看看就行

第6章

6.1 习题6.1.1

6.2 根据事务操作画表 描述状态 图6-2

6.3 图6-3 6-5 6-6 表示形式 第几步出问题 对应使用什么操作 产生什么结果

习题6.2.3

第7章

7.2 概念 判断题 优先图 习题7.2.5

7.8 图7-3,9 四条规则(p236) 习题7.8.1

第8章

8.2 等待图 图8-8 8-9 8-10

第11章

11.1

11.2 A-Priori算法

习题11.2.1

第12章

12.2 PageRank 习题12.2.1 12.2.2







## 2.5 组织磁盘上的数据

在磁盘上存储数据库

用一个记录表示一个数据元素,在磁盘块中的连续字节存放

**记录与磁盘块的基本组织技术**

## 2.5.1 定长记录

最简单类型的记录由定长字段组成,元组的每一个属性对应一个字段

通常字段的起始地址是4或8的倍数

在内存中有效访问记录是必要的

#### 记录以记录的 **首部**开始,包括以下信息:

1.指向该记录中存储数据的**模式**的指针

2.记录长度

3.时间戳 最后一次被修改或被读的时间

4.指向记录的字段的指针

#### 例

```sql
create table MovieStar(
	name CHAR(30) PRIMARY KEY,
	address VARCHAR(255),
    gender CHAR(1),
  	birthday DATE
)
```

该关系的元组有一个头部和以下4个字段:

1.name字段,需要30字节,假设字段以4的倍数开始,为name分配32字节

2.address VARCHAR属性需要定长字节片段,比最大长度多一个字节,255+1=256字节

3.gender属性 一个字节,分配4个字节使下一个字段的起始地址是4的倍数

4.birthday SQL DATE值,是1个10字节的字符串,分配12个字节(4的倍数)

#### 对应记录格式(316字节)

从0开始,分别是

**header**

* 指向记录模式的指针	0-4
* 记录长度    4-8       
* 时间戳    8-12



* name字段    12-44
* address字段    44-300
* gender    300-304
* birthdate    304-316

### 定长记录在块中的放置

标识关系元组的记录存储在磁盘块中,需要存取或修改时,记录被移进主存

| 块首部  | 记录1  | 记录2  | .... | 记录n  |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |

除了记录,有一个可选的块首部,存储以下信息:

1.与一个或者多个块的链接,构成一个块的网络

2.这个块在该网络中扮演的角色信息

3.块的元组属于哪个关系

4.每一条记录在块内的偏移量目录

5.块最后一次修改/存取的时间戳

### 疑问

#### 例2.16

上例格式的记录,假设有4096字节的块,12个字节用于块首部,剩余4084字节由数据使用.装入12条所给316字节格式的记录,**每一块有292字节是被浪费的空间?**

### 习题2.5.1

字段由如下顺序记录:

长度为23的字符串	2字节整数	SQL日期	SQL时间

如果:	记录占用多少字节?

1.字段可在任何字节处开始  4*3+23+2+10+6

2.字段必须在8的倍数的字节处开始

3.字段必须在4的倍数的字节处开始

## 2.7 变长数据和记录

除了有固定模式,且模式是定长字段的列表,还希望表示:

* 大小变化的数据项  : 只分配实际空间
* 重复字段: 表示多对多关系
* 可变格式记录
* 极大的字段:如属性值很大的属性

### 2.7.1 具有变长字段的记录

定长字段放在变长字段之前,首部写入如下信息:

* 记录长度
* 指向除第一个以外所有的变长字段起始处的指针(第一个变长字段一定在记录的定长部分之后)

| 其他首部信息 | 记录长度 | 指向第二个变长地段address | 定长gender | 定长birthdate | 变长name | 变长address |
| ------ | ---- | ---------------- | -------- | ----------- | ------ | :-------- |
|        |      |                  |          |             |        |           |



### 2.7.2 具有重复字段的记录

两种表示方法:

1.假设定长字段F的出现次数可变,将F的每次出现放在一起,在记录首部放一个指针,指向F出现的第一个位置,剩余F的出现位置可通过F的固定长度偏移

| 其他首部信息 | 记录长度 | 指向第二个变长address | 指向重复影片字段 | name | address | 影片   | 影片   | .... | 影片   |
| ------ | ---- | -------------- | -------- | ---- | ------- | ---- | ---- | ---- | ---- |
|        |      |                |          |      |         |      |      |      |      |



2.保持记录定长,将变长部分(变长字段/重复字段)放在另一个块上.记录中存储

* ### 指向每一个重复字段开始处的指针

* 重复次数或者重复结束处

| 记录首部信息 | 指向name | name长度 | 指向address | address长度 | 指向影片引用 | 引用个数 |
| ------ | ------ | ------ | --------- | --------- | ------ | ---- |
|        |        |        |           |           |        |      |

|      | address |      | name |      | 影片   | 影片   | ...  | 影片   |
| ---- | ------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|      |         |      |      |      |      |      |      |      |



**优点**:

* 保持记录定长 有效搜索 减少开销

**缺点:**

* 增加进行的磁盘I/O数目

**折中方案**

在记录定长部分额外存储以下信息

* 重复字段次数合理的出现
* 指向重复字段其他地方出现的实例的指针
* 其他出现的次数

### 2.7.3 可变格式的记录

用带标记的字段序列来表示,每个带标记的字段由**字段值**以及**字段值前的关于字段的角色信息**组成

* 属性或字段名

* 字段类型

* 字段长度

  ​

  | 姓名的编码 | 字符串类型 | 长度   |                | 拥有的餐馆编码 | 字符串类型 | 长度   |                  | ...  |
  | ----- | ----- | ---- | -------------- | ------- | ----- | ---- | ---------------- | ---- |
  | N     | S     | 14   | Clint Eastwood | R       | S     | 16   | Hog's Breath Inn | ...  |

### 2.7.4 不能装入一个块中的记录

对于大值数据通常不能装入一个块中,比如视频音频片段.

使用 **跨块记录**

**记录片段:**出现在一个块中的记录

**跨块:**一个具有两个或多个片段的记录

**不跨块**:不跨越块边界

对于 **跨块记录**,需要额外的首部信息

* 每一条记录/片段首部包含一个二进制位,指明是否是一个片段
* 若是片段,需要几个二进制位指明是否为所属记录的第一个/最后一个
* 对同一条记录有下一个/前一个片段,需要指向这些片段的指针

**块1:**

| 块首部  | 记录首部 | 记录1  | 指向2-b | 记录2-a |
| ---- | ---- | ---- | ----- | ----- |
|      |      |      |       |       |

**块2:**

| 指向2-a | 记录2-b | 记录3  |
| ----- | ----- | ---- |
|       |       |      |

这样就可以把3个大约为块的60%大小的记录存储在2个块中

## 2.7.5 BLOB

**二进制大对象或BLOB:**

真正大的记录值/记录字段值,各种格式的图像,MPEG格式的电影或各种信号

**BLOB的存储**

必须存储在一系列块中,最好在磁盘的一个或多个柱面上连续分配(能有效检索)

有必要将BLOB进行分割,在几个磁盘中交替存储,有利于同时检索,提高检索效率

**BLOB的检索**

只传送记录的"小"字段,同时允许客户端一次一个的请求BLOB块,而与记录的其余部分无关

客户端能请求BLOB内部的部分,而不必接收整个BLOB.那么DBMS需要合适的索引结构

## 2.7.6 列存储

将元组保存为记录的另一个方法是将每一列保存为一个记录,可能被存放在多个磁盘块中.

通常可能进行数据压缩,通过 **位序列存储**的方式压缩数据

### 习题2.7.2

一个病人记录包括以下

定长字段:病人的出生日期,社会保险号码,病人ID,每一个字段都是9字节长

变长字段:姓名,住址和病史

记录内一个指针需要8字节,记录长度是一个2字节整数,不包括变长字段空间

**这条记录需要多少字节?**

变长字段姓名,住址和病史的长度都符合均匀分布

姓名的范围为20-60字节,住址的范围是40-80字节,病史的范围是0-2000字节.**一个病人记录的平均长度是多少?**



## 3.1 索引结构基础

**文件:**构成存储结构

* 数据文件:存储一个关系,可以拥有一个或多个索引文件
* 索引文件:建立查找键和数据记录之间的关联,查找键的指针指向与查找键具有相同属性值的记录

通常为每个数据块在索引文件中设一个索引项

**主索引**能确定记录在数据文件中的位置,而 **辅助索引**不能

在关系的主键上建立主索引,在其他的属性上建立辅助索引

### 3.1.1 顺序文件

**顺序文件:**对关系中的元组按主键进行排序而生成的文件.关系中的元组按照这个次序分布在多个数据块中

### 3.1.2 稠密索引

如果记录是排好序的,我们就可以在记录上建立稠密索引

块中只存放记录的键以及指向记录本身的指针

稠密索引文件中的索引块保持键的顺序与文件中的排序顺序一致

**比数据文件节省存储空间 每次查询只用一次I/O操作**

**索引的高效查找**

* 索引块数量通常比数据块少
* 可以使用二分查找来查找键值
* 足够小的索引文件可以存放在主存缓冲区中,查找键值只涉及主存访问而不需要I/O操作

### 3.1.3 稀疏索引

**稀疏索引:**职位数据文件的每个存储块设一个键-指针对,比稠密索引节省了更多存储空间,但查找给定值记录需要更多的时间



